---
title: "Analisi dei Terremoti e delle faglie nel mondo (1970-2025)"
output:
  pdf_document: default
  html_document: default
  word_document: default
date: ""
---
# Introduzione
In questo lavoro di gruppo, abbiamo deciso di analizzare un dataset preso da [USGS.gov](https://earthquake.usgs.gov/earthquakes/search/), che contiene varie informazioni sui terremoti avvenuti in tutti il mondo dal 1970 al 2025. Il dataset è stato selezionato in modo da avere  solo terremoti di magnitudo superiore a 5.0 della scala Richter. Ci siamo limitati a questa magnitudo in quanto il sito consente di scaricare fino a 20.000 eventi alla volta, quindi per coprire tutta la serie storica è stato necessario unificare tutte le richieste creando un unico dataset con 87798. Inoltre, dal sito [globalquakemodel.org](https://www.globalquakemodel.org/) abbiamo preso la mappa di tutte le faglie attive nel mondo. In questo modo abbiamo potuto confrontare le posizioni dei terremoti rispetto alle faglie. I dati sono stati analizzati tenendo conto sia della loro posizione geografica e di altre caratteristiche presenti nel dataset, sia della loro frequenza nel corso del tempo. Queste analisi sono state effettuate sia attraverso l'utilizzo di mappe, sia attraverso l'utilizzo di grafici al fine di descrivere al meglio tutte le variabili quantitative e qualitative presenti.

## Dataset Faglie
Il dataset contiene la mappa di tutte le faglie attive presenti nel mondo, ed è possibile importarlo tramite il seguente codice:
```{r echo=TRUE, message=FALSE}
library(readr)
library(sf)
library(ggplot2)
library(dplyr)
library(maps)
library(tidyr)
library(RColorBrewer)
library(stringr)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)
library(lubridate)
library(gridExtra)
library(tidyr)
library(corrplot)
library(ggcorrplot)

```
Per semplicità si è deciso di presentare tutte le librerie utilizzate nel lavoro nel precedente blocco di codice.
```{r echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}
faglie <- st_read("gem_active_faults.shp")
ggplot() +
  # Aggiungi la mappa del mondo
  borders("world", colour = "gray50", fill = "lightgray") + 
  # Aggiungi le faglie
  geom_sf(data = faglie, color = "red", size = 1, alpha = 0.7) +
  labs(title = "Faglie Geologiche Attive", x = "Longitudine", y = "Latitudine", 
           color = "Magnitudo") +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    legend.position="right")
```
Nel grafico, viene mostrata la mappa nel mondo in grigio, e in rosso, le faglie geologiche attive. Come si può vedere le faglie si distribuiscono principalemente lungo i confini delle placche tettoniche con una forte concentrazione nella parte sud-ovest dell'Asia a formare la catena dell' Himalaya. 
La presenza di faglie geologiche è di particolare interesse in quanto nei pressi di queste zone si osserva una maggiore probabilità che vi siano terremoti. Questo fenomeno verrà visualizzato in seguito, attraverso il dataset "Earthquake" in cui è presente la lista dei terremoti registrati dal 1970-2025.

## Dataset Earthquake: 

I dati sono stati presi dal sito [USGS.gov](https://earthquake.usgs.gov/earthquakes/search/) filtrati con una magnitudo superiore a 5.0. Essendo la frequenza dei terremoti correlata alla magnitudo il sito consentiva solo di scaricare 20000 eventi per volta, producendo troppe richieste di dati all'ente fornitore. Inoltre, il dataset sull'intero fenomeno era piuttosto frammentato e si è deciso quindi di unire le informazioni distribuite su diversi anni in un unico blocco per avere una visione globale del fenomeno. 

In R, i dati sono stati importati tramite il seguente codice:
```{r echo=TRUE}
terremoti <- read.csv("Earthquake_1970-2025.csv")

```


## Analisi Premilinare.

Il nostro dataset è composto da 22 variabili di varia natura per un totale di quasi 88000 osservazioni. Per semplicità, mostriamo un breve estratto delle variabili piu significative usate nell'analisi del fenomeno. Per una descrizione di tutte le variabili presenti nel database si rimanda a (https://www.usgs.gov/programs/earthquake-hazards/magnitude-types).


```{r echo=TRUE}
library(pander)
pander(head(terremoti %>% select(latitude, longitude, depth, mag, nst, type, time)))

```
Nella seguente tabella, le variabili indicano: 

-  __latitudine e longitudine__: rappresentano le coordinate geografiche di dove è avvenuto il terremoto.
-  __depth__: La profondità, misurata in km rispetto alla superficie terrestre.
- __mag__: la magnitudo del terremoto in scala Richter.
- __nst__: numero di stazioni che hanno registrato il terremoto. 
- __type__: l'origine del terremoto inteso come causa scatenante. (Terremoto terrestre, esplosione nucleare, collasso di miniere, frane ed esplosioni.)
- __time__:  data e ora della rilevazione del fenomeno.

Con la funzione summary mostriamo le caratteristiche delle variabili quantitative mensionate sopra.
```{r echo=TRUE}
pander(summary(terremoti %>% select(latitude, longitude)))
pander(summary(terremoti %>% select(depth, mag, nst)))
```
Ciò che è possibile notare è che per la variabile nst ci sono diversi dati mancanti (NA). Per la variabile depth, si può notare che la mediana e la media non coincidono, lasciando intendere in questa prima fase, la presenza di asimmetria nei dati. Maggiori conferme si hanno guardando la differenza tra il terzo quartile(3rd Qu) e il massimo(Max). Il terzo quartile della variabile mag, ci suggerisce che il 75% dei dati non supera il 5.5 di magnitudo. 


## Analisi Quantitativa
Per iniziare l'esplorazione delle variabili quantitative presenti nel dataset, abbiamo deciso di usare l'istogramma e la funzione di densità di kernel relativi alla magnitudo, la quale rappresenta una delle variabili più importanti per l'analisi del fenomeno studiato.

```{r echo=TRUE, message=FALSE, warning=FALSE}

hist = ggplot(terremoti, aes(x=mag)) +
          geom_histogram(fill="lightblue", color="white", bins=40) +
          theme_minimal() +
          labs(title="ISTOGRAMMA di magnitudo",
               subtitle="Numero di bins = 40",
               x="Magnitudo", 
               y="Frequenza")
 
kernel =  ggplot(terremoti, aes(x=mag)) +
            geom_density(fill="lightblue", bw=bw.nrd0(terremoti$mag)) +
            theme_minimal() +
            labs(title="DENSITÀ DI KERNEL di magnitudo",
                 subtitle="Stimata con parametro di smoothing ottimale",
                 x="Magnitudo", 
                 y="Densità")
 
grid.arrange(hist, kernel, nrow=1)

```

Come evidenziato già nell'analisi preliminare, anche dall'esame dei grafici soprastanti, si evince che la maggior parte dei terremoti presenta una magnitudo inferiore a 6. Tuttavia si nota una forte asimmetria positiva con una coda prolungata che evidenzia anche il verificarsi di terremoti con un valore di magnitudo molto superiore alla media, seppur con poca frequenza. Pertanto al fine di esploare meglio questo andamento abbiamo deciso di riportare anche il box-plot della magnitudo, il quale conferma la presenza di outliers in corrispondenza di valori di magnitudo superiori a 6 e mostra come la quasi totalità dei valori sia compresa nell'intervallo 5 e 6. Anche la media, rappresentata dalla linea tratteggiata in rosso e pari a 5.36, è compresa in tale intervallo. 

```{r echo=TRUE}
boxplot(terremoti$mag, col="lightblue", border="darkblue", horizontal=TRUE,
        main="BOXPLOT di magnitudo", xlab="Magnitudo")
abline(v=mean(terremoti$mag), lty=2, col="darkred")

``` 

Esaminando le variabili presenti nel dataset e la loro descrizione abbiamo ritenuto che ci potesse essere una relazione significativa fra la profondità a cui avviene il fenomeno e la magnitudo dello stesso. Al fine di studiare tale relazione, abbiamo optato per una rappresentazione tramite box-plot e violin.plot, in quanto lo scatterplot risultava confusionario a causa della grossa quantità di dati. Inoltre, sempre per avere una migliroe rappresentazione migliore abbiamo raggrupato in fasce i livelli di magnitudo con un passo di 0.5.

```{r echo=TRUE}

# Filtra i dati e crea le fasce di magnitudo
DS3_filtered <- terremoti %>%
  filter(depth > 0) %>%  # Rimuove profondità negative o zero
  mutate(mag_group = cut(mag, breaks = seq(5, 9, by = 0.5), include.lowest = TRUE)) %>%
  filter(!is.na(mag_group)) %>%  # Rimuove fasce di magnitudo senza dati
  group_by(mag_group) %>%
  filter(n() >= 10) %>%  # Mantiene solo gruppi con almeno 10 osservazioni
  ungroup()

# Creiamo il violin plot
custom_colors <- c("#1F77B4", "#FF7F0E", "#2CA02C", "#D62728", "#9467BD", "#8C564B", "#E377C2", "#7F7F7F")

ggplot(DS3_filtered, aes(x = mag_group, y = depth, fill = mag_group)) +
  geom_violin(scale = "width", alpha = 0.7, color = "black") +  # Bordo nero
  scale_fill_manual(values = custom_colors) +  # Usa la palette personalizzata
  labs(title = "Distribuzione della profondità per fasce di magnitudo",
       x = "Fasce di Magnitudo",
       y = "Profondità (km)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))

```

```{r echo=TRUE}
DS3_filtered <-terremoti %>%
  filter(depth < 300) %>%  # Escludiamo solo outlier estremi
  mutate(mag_group = cut(mag, breaks = seq(5, 9, by = 0.5), include.lowest = TRUE))

# Rimuovi le fasce di magnitudo che non contengono dati
DS3_filtered <- DS3_filtered %>%
  filter(!is.na(mag_group))

# Crea il grafico
library(ggsci)

ggplot(DS3_filtered, aes(x = mag_group, y = depth, fill = mag_group)) +
  geom_boxplot(outlier.colour = "red", outlier.shape = 16) +
  scale_fill_jco() +  # Usa la palette "jco"
  labs(title = "Distribuzione della profondità per fasce di magnitudo",
       x = "Fasce di Magnitudo",
       y = "Profondità (km)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))

```

Dai grafici soprastanti emerge che la maggior parte dei terremoti si verifica a profondità superficiali (tra 0-70 km), come ben evidenziato dalla posizione del box e dalla mediana. Questo riflette la natura della tettonica delle placche, dove l’attività sismica è più frequente lungo i margini delle placche. Sono presenti anche outliers a grandi profondità (addirittura tra 200 e 300 km), anche se questi eventi sono abbastanza rari. 

Successivamente, al fine di esplorare l'esistenza di eventuali relazioni tra le variabili quantitative abbiamo deciso di esaminare la matrice di correlazione, creata utilizzando la funzione "cor" del pacchetto stats, che di default adotta il coefficiente di correlazione lineare di Pearson. Per una migliore interpetazione del valore dei coefficienti, si è deciso di riportare il correlation plot generato tramite il seguente codice. 

```{r echo=TRUE}

##seleziono le variabili per l'analisi
df_corr= terremoti%>%
        dplyr::select(depth, mag, nst, gap, dmin, rms, horizontalError, depthError, 
                      magError, magNst)
df_na=df_corr %>%
        summarise(across(c(depth, mag, nst, gap, dmin, rms, horizontalError, 
                          depthError, magError, magNst), 
                   ~sum(is.na(.)))) 

#### seleziono le variabili da pulire da NA
df_corr_clean <- df_corr %>%
  drop_na(depth, mag, nst, gap, dmin, rms, horizontalError, 
            depthError, magError, magNst)      

#calcolo la matrice di correlazione
df_f=cor(df_corr_clean)

corrplot(df_f, 
         method = "color",    
         type = "full",      
         tl.cex = 0.8,        
         tl.srt = 45,         
         addCoef.col = "black",  
         number.cex = 0.7) 

```

Dal correlation plot si evince che le correlazioni fra le variabili di maggiore interesse sono le seguenti: 

- __Mag e nst__: Queste due variabili appartengono rispettivamente al livello di magnitudo  e al numero di stazioni sismiche che hanno registrato il terremoto. Sono correlate positivamente in quanto un evento con alta magnitudo sarà rilevato da piu stazioni sismiche presenti nel mondo.
- __nst e gap__: Con un maggior numero di stazioni (nst elevato), la copertura attorno all'epicentro è più uniforme, riducendo il gap.
Al contrario, con meno stazioni la copertura è più concentrata, generando un gap più ampio.
- __Mag Error e magNst__:  Queste due variabili appartengono rispettivamente al livello di magnitudo  e al numero di stazioni sismiche che hanno partecipato alla determinazione della magnitudo. Per questo motivo osserviamo un coefficiente di correlazione negativo. 
- __Horizontal Error e dmin__:L'errore orizzontale potrebbe essere correlato alla distanza minima (dmin) perché terremoti più lontani dalla rete di rilevamento (maggiore dmin) tendono ad avere una localizzazione meno precisa, aumentando l'errore orizzontale. Questo è dovuto alla geometria della rete sismica e alla riduzione della precisione con la distanza.
- __Horizontal Error e depth error__: L'errore orizzontale e l'errore di profondità sono spesso correlati perché entrambi dipendono dalla qualità e dalla distribuzione dei dati sismici. Una scarsa copertura strumentale o una geometria sfavorevole possono influenzare simultaneamente la precisione della localizzazione sia in orizzontale che in profondità.

Tra le varie relazioni evidenziate sopra abbiamo deciso di concentrare l'attenzione sul legame tra le variabili dmin (distanza dalla stazione più vicina) e HorizontalError (errore sul rilevamento della posizione), che presentano una correlazione positiva pari a 0.30, come mostrato nel coorelation plot. Pertanto al fine di approfondire questa relazione abbiamo deciso rappresentare lo scatterplot delle due variabili e di confrontare l'adattamento di un modello lineare rispetto ad un modello GAM (Generalized Additive Model), il quale è il modello che si adatta meglio ai dati. In conclusione, pertanto, possiamo dire che la relazione tra queste due variabili risulta non lineare.

```{r echo=TRUE, message=FALSE, warning=FALSE}

ggplot(terremoti, aes(x = dmin, y = horizontalError)) +
  geom_point(color = "lightblue", alpha = 0.8, size = 2) +
  geom_smooth(method = "lm", se = FALSE, aes(color = "Modello Lineare")) +
  geom_smooth(se = FALSE, aes(color = "Modello GAM")) +
  scale_color_manual(
    name = "Modelli",
    values = c("Modello Lineare" = "cornflowerblue", "Modello GAM" = "red")
  ) +
  scale_y_continuous(limits = c(0, 20)) +
  scale_x_continuous(breaks = seq(0, 23, 5), limits = c(0, 23)) +
  theme_minimal() +
  labs(
    title = "Distanza dalla stazione più vicina vs Errore sul rilevamento della posizione",
    subtitle = "Modello Lineare vs Modello GAM",
    x = "Distanza dalla stazione",
    y = "Errore posizione"
  ) +
  theme(legend.position = "right")

 
```
 
Infine, abbiamo deciso di analizzare l'evoluzione del numero di terremoti avvenuti a livello globale nel periodo di riferimento (1970-2025).

```{r echo=TRUE, message=FALSE, warning=FALSE}
gg=   terremoti %>%
      mutate(Anno=year(as.Date(time)))%>%
      group_by(Anno) %>%
      summarise(Conteggio= n(), magnitudomedia=mean(mag))

ggplot(gg, aes(x = Anno, y = Conteggio)) +
       geom_line(color = "blue") +
  labs(title = "Serie Temporale dei Terremoti (Raggruppati per Anno)", x = "Anno", y = "Numero di Terremoti")

```

La serie storica annuale evidenzia come il numero di terremoti sia contenuto nell'intervallo tra 1500-2000 terremoti per la maggior parte degli anni studiati. Tuttavia, nel periodo compreso tra il 2005 e il 2010 c'è stato un incremento siginificativo del numero di terremoti, raggiungendo il picco, superiore a 2500 terremoti, nel 2010.

Avendo informazioni relative alla latitudine e alla longitudine c'è sembrato interessante anche studiare questo fenomeno in base al continente dove è avvenuto, con l'idea di cercare di capire in quali continenti il fenomeno risulta particolarmente concentrato. A tal fine mediante il codice che riportiamo di seguito abbiamo prima collegato il continente e lo stato alle osservazioni del database oggetto di studio, e successivamente lo abbiamo filtrato andando a considerare soltanto una parte delle osservazioni contenute in esso. Questo perché a causa di una diversa approssimazione di latitudine e longitudine per alcune osservazioni il collegamento con lo stato e il continente non risultava particolarmente preciso.

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(sp)
library(rworldmap)

coordinates_continent = function(points)
{  
  countriesSP <- getMap(resolution='high')
  pointsSP = SpatialPoints(points,                                          proj4string=CRS(proj4string(countriesSP)))  
  indices = over(pointsSP, countriesSP)
  indices$REGION   
}
 
coordinates_country = function(points)
{  
  countriesSP <- getMap(resolution='high')
  pointsSP = SpatialPoints(points,                                          proj4string=CRS(proj4string(countriesSP)))  
  indices = over(pointsSP, countriesSP)
  indices$ADMIN 
}

terremoti2 = terremoti

terremoti2$continent = coordinates_continent(data.frame(as.integer(terremoti$longitude),as.integer(terremoti$latitude)))

terremoti2$continent = recode(terremoti2$continent,"South America and the Caribbean"="South America")

terremoti2$country = coordinates_country(data.frame(as.integer(terremoti$longitude),as.integer(terremoti$latitude)))

terremoti2 = filter(terremoti2, type=="earthquake" & continent!="<NA>" & continent!="Antarctica")

```

Innanzitutto, riportiamo il pie chart relativo al continente nel quale è avvenuto l'evento, da cui si evince come la maggior parte dei terremoti ha avuto luogo in Asia (circa il 44%) e in Sudamerica (circa il 32%).

```{r echo=TRUE, message=FALSE, warning=FALSE}

data_piechart = terremoti2 %>% count(continent) %>%
                                arrange(desc(continent)) %>%
                                mutate(perc = round(n/sum(n)*100, 2),
                                ypos_l = cumsum(perc)-0.5*perc,
                                perc_l = paste0(round(n/sum(n)*100, 2),"%"))

ggplot(data_piechart, aes(x="", y=perc, fill=continent)) +
  geom_bar(stat="identity", width=1, color="black") +
  geom_text(aes(y=ypos_l, label=perc_l), color="black", size=3.5) +
  coord_polar("y", start=0, direction=-1) +
  theme_void() +
  scale_fill_brewer(palette="Set2") +
  labs(title="PIE CHART di continente",
       fill="Continente")

rm(data_piechart)

```

Successivamente, al fine di vedere il comportamento del fenomeno nei diversi continenti, abbiamo deciso di concentrare l'attenzione sulla variabile relativa alla magnitudo. A tal fine, di seguito riportiamo alcune statistiche di sintesi della magnitudo per continente.

```{r echo=TRUE, message=FALSE, warning=FALSE}

cbind(min = tapply(terremoti2$mag, droplevels(terremoti2$continent), min),
      max = tapply(terremoti2$mag, droplevels(terremoti2$continent), max),
      mean = tapply(terremoti2$mag, droplevels(terremoti2$continent), mean),
      median = tapply(terremoti2$mag, droplevels(terremoti2$continent), median),
      sd = tapply(terremoti2$mag, droplevels(terremoti2$continent), sd))

```
Inoltre, riportiamo di seguito prima il ridgeline graph e poi il cleveland plot. Avendo notato che il valore massimo della magnitudo è stato rilevato in Sudamerica, abbiamo deciso di approfondire il comportamento del fenomeno in questa macroregione. Specifichiamo che nei grafici relativi al al solo Sudamerica sono stati considerati soltanto gli stati per cui il numero di osservazioni a disposizione fosse almeno pari a 30.

```{r echo=TRUE, message=FALSE, warning=FALSE}

library(ggridges)
ridge_1 = ggplot(terremoti2, aes(x=mag, y=continent, fill=continent)) +
            geom_density_ridges() + 
            theme_ridges() +
            theme(legend.position="none") +
            labs(title="RIDGELINE GRAPH",
                 subtitle="Per continente",
                 x="Magnitudo", 
                 y="Continente")

data_ridge_2a = terremoti2 %>% filter(continent=="South America")
tab_ridge_2 = data.frame(table(droplevels(data_ridge_2a$country))) %>% filter(Freq>=30) %>%
                                                                      rename(country=Var1)
data_ridge_2b = inner_join(data_ridge_2a, tab_ridge_2, by="country")

ridge_2 = ggplot(data_ridge_2b, aes(x=mag, y=country, fill=country)) +
  geom_density_ridges() + 
  theme_ridges() +
  theme(legend.position="none") +
  labs(title="",
       subtitle="Per stato del Sudamerica",
       x="Magnitudo", 
       y="Stato")

grid.arrange(ridge_1, ridge_2, nrow=1)

rm(ridge_1, ridge_2, data_ridge_2a, data_ridge_2b, tab_ridge_2)

```

Dal ridgeline graph per continente si evince che le varie distribuzioni presentano un andamento molto simile tra loro e simile a quello relativo alla distribuzione della magnitudo sull'intero database, mostrato nell'istogramma di pagina XX.
Concentrando poi l'attenzione sul solo Sudamerica, la distribuzione della magnitudo risulta sempre simile tra i vari stati con una forte assimmetria positiva; soltanto il Brasile presenta una distribuzione visibilmente differente.

```{r echo=TRUE, message=FALSE, warning=FALSE}

data_cleveland = terremoti2 %>% group_by(continent) %>%
                                 summarise(max=max(mag))

cleveland_1 = ggplot(data_cleveland, aes(x=max, y=reorder(continent,max))) +
                geom_point(color="darkblue", size = 2.5) +
                geom_segment(aes(x=min(terremoti2$mag), xend=max,
                                 y=reorder(continent,max), yend=reorder(continent,max)),
                                 color="lightblue") +
                theme_minimal() + 
                theme(panel.grid.major=element_blank(),
                      panel.grid.minor=element_blank()) +
                labs(title="CLEVELAND PLOT di magnitudo massima",
                     subtitle="Per continente",
                     x="Magnitudo", 
                     y="") 

data_cleveland_2a = terremoti2 %>% filter(continent=="South America")
tab_cleveland_2 = data.frame(table(droplevels(data_cleveland_2a$country))) %>%
                      filter(Freq>=30) %>% rename(country=Var1)
data_cleveland_2b = inner_join(data_cleveland_2a, tab_cleveland_2, by="country") %>%
                        group_by(country) %>% summarise(max=max(mag))

cleveland_2 = ggplot(data_cleveland_2b, aes(x=max, y=reorder(country,max))) +
                  geom_point(color="darkblue", size = 2.5) +
                  geom_segment(aes(x=min(terremoti2$mag), xend=max,
                                   y=reorder(country,max), yend=reorder(country,max)),
                               color="lightblue") +
                  theme_minimal() + 
                  theme(panel.grid.major=element_blank(),
                        panel.grid.minor=element_blank()) +
                  labs(title="",
                       subtitle="Per stato del Sudamerica",
                       x="Magnitudo", 
                       y="")

grid.arrange(cleveland_1, cleveland_2, nrow=1)

rm(data_cleveland, cleveland_1, cleveland_2, data_cleveland_2a, data_cleveland_2b, tab_cleveland_2)

```

Infine, il Cleveland plot soprastante riporta per i vari continenti e per i vari stati sudamericani la magnitudo massima rilevata. Da essi si evince come il valore massimo della magnitudo nel periodo 1975-2025 è stato rilevato in Sudamerica e in particolare in Cile.
